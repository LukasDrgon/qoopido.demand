/*! Qoopido.demand 0.0.1, 2015-09-05 | https://github.com/dlueth/qoopido.demand | (c) 2015 Dirk Lueth */
!function(e){"use strict";function t(){var e=this||{},t=s(e,x)?e:null,n=H.call(arguments);return n.forEach(function(e,n){var r=E.path(e,t),a=r.handler,u=r.path,l=ie[a]||(ie[a]={});this[n]=l[u]||(l[u]=new y(e,t).pledge)},n),d.all(n)}function n(){var e,t,n=p(arguments[0],G)&&arguments[0]||null,r=!n&&arguments[0]||arguments[1];if(!n&&j.current&&(t=j.current,n=t.handler+"!"+t.path),!n)throw new m("unspecified anonymous provide");return P(function(){var a,l,o,i=E.path(n),c=ie[i.handler];!t&&c[i.path]?u("duplicate found for module "+i.path):(a=new x(n,r,e||[]),l=ie[a.handler][a.path]=a.pledge,t&&(!t.cached&&t.store(),o=t.defered,l.then(function(){o.resolve.apply(null,arguments)},function(){o.reject(new m("unable to resolve module",n,arguments))}),j.length>0&&j.next()))}),{when:function(){e=H.call(arguments)}}}function r(e){var t,n=e.cache,r=e.debug,a=e.version,u=e.timeout,l=e.lifetime,o=e.base,i=e.pattern,c=e.probes;if(I=p(n,Q)?n:I,M=p(r,Q)?r:M,R=p(a,G)?a:R,h(u)&&(A=1e3*Math.min(Math.max(u,2),10),D=Math.min(Math.max(A/5,1e3),5e3)),h(l)&&(N=1e3*Math.max(l,0)),p(o,G)&&(q=ce.base=new g(Z,E.url(o))),f(i))for(t in i)"base"!==t&&(ce[t]=new g(t,i[t]));if(f(c))for(t in c)se[t]=c[t];return!0}function a(e,t,n){pe[e]||(pe[e]={suffix:t,resolve:n.resolve,modify:n.modify},ie[e]={})}function u(e){var t=s(e,m)?"error":"warn";p(console,F)||!M&&"warn"===t||console[t](e.toString())}function l(e,t){return new RegExp(e,t)}function o(e){return e.replace(te,"\\$&")}function i(e){return e.replace(re,"")}function c(e){return _.test(e)}function s(e,t){return e instanceof t}function p(e,t){return typeof e===t}function f(e){return e&&p(e,"object")}function h(e){return p(e,"number")&&isFinite(e)&&Math.floor(e)===e&&e>=0}function d(e){function t(){r(K,arguments)}function n(){r(V,arguments)}function r(e,t){a.state===z&&(a.state=e,a.value=t,u[e].forEach(function(e){e.apply(null,a.value)}))}var a=this,u={resolved:[],rejected:[]};a.then=function(e,t){var n=this;if(n.state===z)e&&u[K].push(e),t&&u[V].push(t);else switch(n.state){case K:e.apply(null,n.value);break;case V:t.apply(null,n.value)}},e(t,n)}function m(e,t,n){var r=this;return r.message=e,r.module=t,n&&(r.stack=H.call(n)),r}function g(e,t){var n=this;n.url=E.url(t),n.regexPattern=s(e,RegExp)?e:l("^"+o(e)),n.regexUrl=l("^"+o(t))}function v(){var e=this;e.current=null,e.queue=[]}function y(e,t){var n,r,a=this,l=d.defer();return E.path.call(a,e,t),a.defered=l,a.pledge=l.pledge,r=pe[a.handler],parent||a.pledge.then(null,u),r?(a.retrieve(),a.cached?j.add(a):(n=w.test(a.url)?new W:new Y,n.onprogress=function(){},n.ontimeout=n.onerror=n.onabort=function(){l.reject(new m("unable to load module",a.path))},n.onload=function(){a.source=n.responseText,j.add(a)},n.open("GET",a.url+r.suffix,!0),n.send(),P(function(){n.readyState<4&&n.abort()},A))):l.reject(new m('no handler "'+a.handler+'" for',a.path)),a}function x(e,n,r){var a=this,l=d.defer();return E.path.call(a,e),(a.pledge=l.pledge).then(null,function(){u(new m("unable to resolve module",a.path,arguments))}),r.length>0?t.apply(a,r).then(function(){l.resolve(n.apply(null,arguments))},function(){l.reject(new m("unable to resolve dependencies for",a.path,arguments))}):l.resolve(n()),a}var w,b,j,E,S,k,T,q,I,M,A,D,R,N,O=e.document,P=e.setTimeout,H=Array.prototype.slice,J=Array.prototype.concat,U=O.getElementsByTagName("head")[0],X=O.createElement("a"),$=e.localStorage,C="[demand]",L="[state]",B="[value]",F="undefined",G="string",Q="boolean",z="pending",K="resolved",V="rejected",W=e.XMLHttpRequest,Y="XDomainRequest"in e&&e.XDomainRequest||W,Z=/^/,_=/^\//i,ee=/^([-\w]+\/[-\w]+)!/,te=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,ne=/url\(\s*(?:"|'|)(?!data:|http:|https:|\/)(.+?)(?:"|'|)\)/g,re=/^http(s?):/,ae=$&&"remainingSpace"in $,ue={cache:!0,debug:!1,version:"1.0.0",lifetime:0,timeout:5,base:"/"},le=e.demand.main,oe=e.demand.settings,ie={},ce={},se={},pe={};E={url:function(e){return X.href=e,X.href},path:function(e,t){var n,r,a=this,u=e.match(ee)||"application/javascript",f=s(a,y);p(u,G)||(e=e.replace(l("^"+o(u[0])),""),u=u[1]),e=c(e)?q.remove(E.url(q.url+e)):"/"+E.url((t&&t.path&&E.url(t.path+"/../")||"/")+e).replace(w,"");for(n in ce)ce[n].matches(e)&&(r=ce[n]);return f||s(a,x)?(a.handler=u,a.path=e,f&&(a.url=i(E.url(r.process(e)))),void 0):{handler:u,path:e}}},S={get:function(e,t){var n,r;if($&&I){if(n=C+"["+e+"]",r=JSON.parse($.getItem(n+L)),r&&r.version===R&&r.url===t&&(0===r.expires||r.expires>(new Date).getTime()))return $.getItem(n+B);S.clear(e)}},set:function(e,t,n){var r,a;if($&&I){r=C+"["+e+"]";try{if(a=ae?$.remainingSpace:null,$.setItem(r+B,t),$.setItem(r+L,JSON.stringify({version:R,expires:N>0?(new Date).getTime()+N:0,url:n})),null!==a&&$.remainingSpace===a)throw"QuotaExceedError"}catch(l){u("unable to cache module "+e)}}},clear:function(e){var t,n,r,a;if($&&I)switch(typeof e){case G:t=C+"["+e+"]",$.removeItem(t+L),$.removeItem(t+B);break;case Q:for(n in $)r=n.match(b),r&&(a=JSON.parse($.getItem(C+"["+r[1]+"]"+L)),a&&a.expires>0&&a.expires<=(new Date).getTime()&&S.clear(r[1]));break;case F:for(n in $)0===n.indexOf(C)&&$.removeItem(n)}}},d.prototype={constructor:d,state:z,value:null,listener:null,then:null},d.defer=function(){var e={};return e.pledge=new d(function(t,n){e.resolve=t,e.reject=n}),e},d.all=function(e){var t=d.defer(),n=t.pledge,r=[],a=[],u=e.length,l=0;return e.forEach(function(e,n){e.then(function(){r[n]=H.call(arguments),l++,l===u&&t.resolve.apply(null,J.apply([],r))},function(){a.push(H.call(arguments)),a.length+l===u&&t.reject.apply(null,J.apply([],a))})}),n},d.race=function(e){var t=d.defer();return e.forEach(function(e){e.then(t.resolve,t.reject)}),t.pledge},m.prototype={message:null,module:null,stack:null,toString:function(){var e=this,t=C+" "+e.message+" "+e.module;return e.stack&&(t=m.traverse(e.stack,t,1)),t}},m.traverse=function(e,t,n){var r=new Array(n+1).join(" ");return e.forEach(function(e){t+="\n"+r+"> "+e.message+" "+e.module,e.stack&&(t=m.traverse(e.stack,t,n+1))}),t},g.prototype={url:null,regexPattern:null,regexUrl:null,matches:function(e){return this.regexPattern.test(e)},remove:function(e){return e.replace(this.regexUrl,"")},process:function(e){var t=this;return e.replace(t.regexPattern,t.url)}},v.prototype={current:null,queue:null,length:0,add:function(e){var t=this,n=t.queue;n.push(e),t.length++,1===n.length&&t.next()},next:function(){var e,t,n,r=this,a=r.current,u=r.queue;a&&(r.current=null,u.shift(),r.length--),u.length&&(a=r.current=r.queue[0],e=a.defered,t=a.path,n=pe[a.handler],!a.cached&&n.modify&&(a.source=n.modify(a.url,a.source)),n.resolve(t,a.source),se[t]&&a.probe(),P(function(){e.reject(new m("timeout resolving module",t))},D))}},y.prototype={handler:null,path:null,url:null,defered:null,pledge:null,cached:!1,source:null,probe:function(){var e,t=this,r=t.path,a=t.pledge.state===z;a&&((e=se[r]())?n(function(){return e}):P(t.probe,100))},store:function(){var e=this;S.set(e.path,e.source,e.url)},retrieve:function(){var e=this,t=S.get(e.path,e.url),n=e.cached=!!t;n&&(e.source=t)}},x.prototype={handler:null,path:null,pledge:null},k={resolve:function(e,t){var n=O.createElement("script");n.type="application/javascript",n.defer=n.async=!0,n.text=t,n.setAttribute("demand-path",e),U.appendChild(n)}},T={resolve:function(e,t){var r=O.createElement("style"),a=r.styleSheet;r.type="text/css",r.media="only x",a&&(a.cssText=t)||(r.innerHTML=t),r.setAttribute("demand-path",e),U.appendChild(r),P(function(){n(function(){return r})})},modify:function(e,t){for(var n,r=E.url(e+"/..");n=ne.exec(t);)t=t.replace(n[0],"url("+E.url(r+n[1])+")");return t}},w=l("^"+o(E.url("/"))),b=l("^"+o(C+"[(.+?)]"+L+"$")),j=new v,S.clear(!0),a("application/javascript",".js",k),a("text/css",".css",T),r(ue)&&oe&&r(oe),t.configure=r,t.addHandler=a,t.clear=S.clear,e.demand=t,e.provide=n,n("/demand",function(){return t}),n("/provide",function(){return n}),n("/pledge",function(){return d}),le&&t(le)}(this);