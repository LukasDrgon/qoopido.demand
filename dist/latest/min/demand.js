/*! Qoopido.demand 0.0.1, 2015-09-03 | https://github.com/dlueth/qoopido.demand | (c) 2015 Dirk Lueth */
!function(e){"use strict";function t(){var e=this||{},t=i(e,m)?e:null,n=q.call(arguments);return n.forEach(function(e,n){var r=j.path(e,t),a=r.handler,l=r.path,u=Z[a]||(Z[a]={});this[n]=u[l]||(u[l]=new d(e,t).pledge)},n),s.all(n)}function n(){var e,t,n=arguments[0]&&"string"==typeof arguments[0]&&arguments[0]||null,r=!n&&arguments[0]||arguments[1];if(!n&&E.current&&(t=E.current,n=t.handler+"!"+t.path),!n)throw new p("unspecified anonymous provide");return M(function(){var a,l,u,o=j.path(n),c=Z[o.handler];if(!t&&c[o.path])throw new p("duplicate found for module",n);a=new m(n,r,e||[]),l=Z[a.handler][a.path]=a.pledge,t&&(!t.cached&&t.store(),u=t.defered,l.then(function(){u.resolve.apply(null,arguments)},function(){u.reject(new p("unable to resolve module",n,arguments))}),E.length>0&&E.next())}),{when:function(){e=q.call(arguments)}}}function r(e){var t,n=e.timeout,r=e.version,a=e.lifetime,l=e.base,u=e.pattern,o=e.probes;if(typeof e.cache!==P&&(v=!!e.cache),n&&(y=1e3*Math.min(Math.max(parseInt(n,10),2),10),x=Math.min(Math.max(y/5,1e3),5e3)),r&&(w=r),a&&(b=1e3*Math.max(parseInt(a,10),0)),l&&(g=_.base=new f(C,j.url(l).href)),u)for(t in u)"base"!==t&&(_[t]=new f(t,u[t]));if(o)for(t in o)ee[t]=o[t];return!0}function a(e,t,n){te[e]||(te[e]={suffix:t,resolve:n.resolve,modify:n.modify},Z[e]={})}function l(e){var t=i(e,p)?"error":"warn";typeof console!==P&&console[t](e.toString())}function u(e){return e.replace(G,"\\$&")}function o(e){return L.test(e)}function c(e){return e.replace(X,"")}function i(e,t){return e instanceof t}function s(e){function t(){r(U,arguments)}function n(){r($,arguments)}function r(e,t){a.state===J&&(a.state=e,a.value=t,l[e].forEach(function(e){e.apply(null,a.value)}))}var a=this,l={resolved:[],rejected:[]};a.then=function(e,t){var n=this;if(n.state===J)e&&l[U].push(e),t&&l[$].push(t);else switch(n.state){case U:e.apply(null,n.value);break;case $:t.apply(null,n.value)}},e(t,n)}function p(e,t,n){var r=this;return r.message=e,r.module=t,n&&(r.stack=q.call(n)),r}function f(e,t){var n=this;n.url=j.url(t).href,n.regexPattern=i(e,RegExp)?e:new RegExp("^"+u(e)),n.regexUrl=new RegExp("^"+u(t))}function h(){var e=this;e.current=null}function d(e,t){var n,r=this,a=s.defer(),u=new XMLHttpRequest;return j.path.call(r,e,t),r.defered=a,r.pledge=a.pledge,n=te[r.handler],parent||r.pledge.then(null,l),n?(r.retrieve(),r.cached?E.add(r):(u.onreadystatechange=function(){4===u.readyState&&(200===u.status||0===u.status&&u.responseText?(r.source=u.responseText,E.add(r)):a.reject(new p("unable to load module",r.path)))},u.open("GET",r.url+n.suffix,!0),u.send(),M(function(){u.readyState<4&&u.abort()},y))):a.reject(new p('no handler "'+r.handler+'" for',r.path)),r}function m(e,n,r){var a=this,u=s.defer();return j.path.call(a,e),(a.pledge=u.pledge).then(null,function(){l(new p("unable to resolve module",a.path,arguments))}),r.length>0?t.apply(a,r).then(function(){u.resolve(n.apply(null,arguments))},function(){u.reject(new p("unable to resolve dependencies for",a.path,arguments))}):u.resolve(n()),a}var g,v,y,x,w,b,E,j,S,I,T,k=e.document,M=e.setTimeout,q=Array.prototype.slice,A=Array.prototype.concat,R=k.getElementsByTagName("head")[0],N=k.createElement("a"),O="[demand]",P="undefined",D="[state]",H="[value]",J="pending",U="resolved",$="rejected",C=/^/,L=/^\//i,B=/^([-\w]+\/[-\w]+)!/,G=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,Q=/url\(\s*(?:"|'|)(?!data:|http:|https:|\/)(.+?)(?:"|'|)\)/g,X=/^http(s?):/,z=/^\[demand\]\[(.+?)\]\[state\]$/,F=e.localStorage,K=F&&typeof F.remainingSpace!==P,V={cache:!0,version:"1.0.0",lifetime:0,timeout:5,base:"/"},W=e.demand.main,Y=e.demand.settings,Z={},_={},ee={},te={};j={url:function(e){return N.href=e,N},path:function(e,t){var n,r,a=this,l=e.match(B)||"application/javascript",s=i(a,d);"string"!=typeof l&&(e=e.replace(new RegExp("^"+u(l[0])),""),l=l[1]),e=o(e)?g.remove(j.url(g.url+e).href):j.url((t&&t.path+"/../"||"/")+e).pathname;for(n in _)_[n].matches(e)&&(r=_[n]);return s||i(a,m)?(a.handler=l,a.path=e,s&&(a.url=c(j.url(r.process(e)).href)),void 0):{handler:l,path:e}}},S={get:function(e,t){var n,r;if(F&&v){if(n=O+"["+e+"]",r=JSON.parse(F.getItem(n+D)),r&&r.version===w&&r.url===t&&(0===r.expires||r.expires>(new Date).getTime()))return F.getItem(n+H);S.clear(e)}},set:function(e,t,n){var r,a;if(F&&v){r=O+"["+e+"]";try{if(a=K?F.remainingSpace:null,F.setItem(r+H,t),F.setItem(r+D,JSON.stringify({version:w,expires:b>0?(new Date).getTime()+b:0,url:n})),null!==a&&F.remainingSpace===a)throw"QuotaExceedError"}catch(u){l("unable to cache module "+e)}}},clear:function(e){var t,n,r,a;if(F&&v)switch(typeof e){case"string":t=O+"["+e+"]",F.removeItem(t+D),F.removeItem(t+H);break;case"boolean":for(n in F)r=n.match(z),r&&(a=JSON.parse(F.getItem(O+"["+r[1]+"]"+D)),a&&a.expires>0&&a.expires<=(new Date).getTime()&&S.clear(r[1]));break;case P:for(n in F)0===n.indexOf(O)&&F.removeItem(n)}}},s.prototype={constructor:s,state:J,value:null,listener:null,then:null},s.defer=function(){var e={};return e.pledge=new s(function(t,n){e.resolve=t,e.reject=n}),e},s.all=function(e){var t=s.defer(),n=t.pledge,r=[],a=[],l=e.length,u=0;return e.forEach(function(e,n){e.then(function(){r[n]=q.call(arguments),u++,u===l&&t.resolve.apply(null,A.apply([],r))},function(){a.push(q.call(arguments)),a.length+u===l&&t.reject.apply(null,A.apply([],a))})}),n},s.race=function(e){var t=s.defer();return e.forEach(function(e){e.then(t.resolve,t.reject)}),t.pledge},p.prototype={message:null,module:null,stack:null,toString:function(){var e=this,t=O+" "+e.message+" "+e.module;return e.stack&&(t=p.traverse(e.stack,t,1)),t}},p.traverse=function(e,t,n){var r=new Array(n+1).join(" ");return e.forEach(function(e){t+="\n"+r+"> "+e.message+" "+e.module,e.stack&&(t=p.traverse(e.stack,t,n+1))}),t},f.prototype={url:null,regexPattern:null,regexUrl:null,matches:function(e){return this.regexPattern.test(e)},remove:function(e){return e.replace(this.regexUrl,"")},process:function(e){var t=this;return e.replace(t.regexPattern,t.url)}},h.prototype={current:null,queue:null,length:0,add:function(e){var t=this,n=t.queue;n.push(e),t.length++,1===n.length&&t.next()},next:function(){var e,t,n,r=this,a=r.current,l=r.queue;a&&(r.current=null,l.shift(),r.length--),l.length&&(a=r.current=r.queue[0],e=a.defered,t=a.path,n=te[a.handler],!a.cached&&n.modify&&(a.source=n.modify(a.url,a.source)),n.resolve(t,a.source),ee[t]&&a.probe(),M(function(){e.reject(new p("timeout resolving module",t))},x))}},d.prototype={handler:null,path:null,url:null,defered:null,pledge:null,cached:!1,source:null,probe:function(){var e=this,t=e.path,r=e.pledge,a=r.state===J,l=ee[t]();l&&a?n(function(){return l}):a&&M(e.probe,100)},store:function(){var e=this;S.set(e.path,e.source,e.url)},retrieve:function(){var e=this,t=S.get(e.path,e.url),n=e.cached=!!t;n&&(e.source=t)}},m.prototype={handler:null,path:null,pledge:null},I={resolve:function(e,t){var n=k.createElement("script");n.type="application/javascript",n.defer=n.async=!0,n.text=t,n.setAttribute("demand-path",e),R.appendChild(n)}},T={resolve:function(e,t){var r=k.createElement("style"),a=r.styleSheet;r.type="text/css",r.media="only x",a&&(a.cssText=t)||(r.innerHTML=t),r.setAttribute("demand-path",e),R.appendChild(r),M(function(){n(function(){return r})})},modify:function(e,t){for(var n,r=j.url(e+"/..").href;n=Q.exec(t);)t=t.replace(n[0],"url("+j.url(r+n[1]).pathname+")");return t}},E=new h,S.clear(!0),a("application/javascript",".js",I),a("text/css",".css",T),r(V)&&Y&&r(Y),t.configure=r,t.addHandler=a,t.clear=S.clear,e.demand=t,e.provide=n,n("/demand",function(){return t}),n("/provide",function(){return n}),n("/pledge",function(){return s}),W&&t(W)}(this);