/*! Qoopido.demand 1.0.0, 2015-09-07 | https://github.com/dlueth/qoopido.demand | (c) 2015 Dirk Lueth */
!function(e){"use strict";function t(e){var t=this||{},n=p(t,x)?t:null,r=J.call(arguments);return r.forEach(function(e,t){var r=S.path(e,n),a=r.handler,u=r.path,l=se[a]||(se[a]={});this[t]=l[u]||(l[u]=new w(e,n).pledge)},r),m.all(r)}function n(e,t){var n,r;if(e=f(arguments[0],z)&&arguments[0]||null,t=e?arguments[1]:arguments[0],!e&&E.current&&(n=E.current,e=n.handler+"!"+n.path),!e)throw new g("unspecified anonymous provide");return U(function(){var a,u,o,i=S.path(e),c=se[i.handler];!n&&c[i.path]?l("duplicate found for module "+i.path):(a=new x(e,t,r||[]),u=se[a.handler][a.path]=a.pledge,n&&(n.timeout=H(n.timeout),o=n.defered,!n.cached&&n.store(),u.then(function(){o.resolve.apply(null,arguments)},function(){o.reject(new g("unable to resolve module",e,arguments))}),E.length>0&&E.next()))}),{when:function(){r=J.call(arguments)}}}function r(e){var t,n=e.cache,r=e.debug,a=e.version,u=e.timeout,l=e.lifetime,o=e.base,i=e.pattern,c=e.probes;if(M=f(n,K)?n:M,O=f(r,K)?r:O,P=f(a,z)?a:P,d(u)&&(A=1e3*Math.min(Math.max(u,2),10),D=Math.min(Math.max(A/5,1e3),5e3)),d(l)&&(R=1e3*l),f(o,z)&&(q=pe.base=new v("",S.url(o))),h(i))for(t in i)"base"!==t&&(pe[t]=new v(t,i[t]));if(h(c))for(t in c)fe[t]=c[t];return!0}function a(e,t,n){he[e]||(he[e]={suffix:t,resolve:n.resolve,modify:n.modify},se[e]={})}function u(e,t){n(e,function(){return t})}function l(e){var t=p(e,g)?"error":"warn";f(console,Q)||!O&&"warn"===t||console[t](e.toString())}function o(e,t){return new RegExp(e,t)}function i(e){return e.replace(ne,"\\$&")}function c(e){return e.replace(ue,"")}function s(e){return ee.test(e)}function p(e,t){return e instanceof t}function f(e,t){return typeof e===t}function h(e){return e&&f(e,"object")}function d(e){return f(e,"number")&&isFinite(e)&&Math.floor(e)===e&&e>=0}function m(e){function t(){r(W,arguments)}function n(){r(Y,arguments)}function r(e,t){a.state===V&&(a.state=e,a.value=t,u[e].forEach(function(e){e.apply(null,a.value)}))}var a=this,u={resolved:[],rejected:[]};a.then=function(e,t){if(a.state===V)e&&u[W].push(e),t&&u[Y].push(t);else switch(a.state){case W:e.apply(null,a.value);break;case Y:t.apply(null,a.value)}},e(t,n)}function g(e,t,n){var r=this;r.message=e,r.module=t,n&&(r.stack=J.call(n))}function v(e,t){var n=this;n.weight=e.length,n.url=S.url(t),n.regexPattern=o("^"+i(e)),n.regexUrl=o("^"+i(t))}function y(){var e=this;e.current=null,e.queue=[]}function w(e,t){var n,r,a=this,u=m.defer();S.path.call(a,e,t),a.defered=u,a.pledge=u.pledge,r=he[a.handler],t||a.pledge.then(null,l),r?(a.retrieve(),a.cached?E.add(a):(n=b.test(a.url)?new Z:new _,n.onprogress=function(){},n.ontimeout=n.onerror=n.onabort=function(){u.reject(new g("unable to load module",a.path))},n.onload=function(){a.timeout=H(a.timeout),a.source=n.responseText,E.add(a)},n.open("GET",a.url+r.suffix,!0),n.send(),a.timeout=U(function(){n.readyState<4&&n.abort()},A))):u.reject(new g('no handler "'+a.handler+'" for',a.path))}function x(e,n,r){var a=this,u=m.defer();S.path.call(a,e),(a.pledge=u.pledge).then(null,function(){l(new g("unable to resolve module",a.path,arguments))}),r.length>0?t.apply(a,r).then(function(){u.resolve(n.apply(null,arguments))},function(){u.reject(new g("unable to resolve dependencies for",a.path,arguments))}):u.resolve(n())}var b,j,E,S,T,I,k,q,M,O,A,D,P,R,N=e.document,U=e.setTimeout,H=e.clearTimeout,J=Array.prototype.slice,L=Array.prototype.concat,X=N.getElementsByTagName("head")[0],$=N.createElement("a"),C=e.localStorage,B="[demand]",F="[state]",G="[value]",Q="undefined",z="string",K="boolean",V="pending",W="resolved",Y="rejected",Z=e.XMLHttpRequest,_="XDomainRequest"in e&&e.XDomainRequest||Z,ee=/^\//i,te=/^([-\w]+\/[-\w]+)!/,ne=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,re=/\/\/#\s+sourceMappingURL\s*=\s*(.+?)\.map/g,ae=/url\(\s*(?:"|'|)(?!data:|http:|https:|\/)(.+?)(?:"|'|)\)/g,ue=/^http(s?):/,le=C&&"remainingSpace"in C,oe={cache:!0,debug:!1,version:"1.0.0",lifetime:0,timeout:5,base:"/"},ie=e.demand.main,ce=e.demand.settings,se={},pe={},fe={},he={};S={url:function(e){return $.href=e,$.href},path:function(e,t){var n,r,a=this,u=e.match(te)||"application/javascript",l=p(a,w);f(u,z)||(e=e.replace(o("^"+i(u[0])),""),u=u[1]),s(e)||(e="/"+S.url((t&&t.path&&S.url(t.path+"/../")||"/")+e).replace(b,""));for(n in pe)pe[n].matches(e)&&(!r||r.weight<pe[n].weight)&&(r=pe[n]);return l||p(a,x)?(a.handler=u,a.path=e,l&&(a.url=c(S.url(r.process(e)))),void 0):{handler:u,path:e}}},T={get:function(e,t){var n,r;if(C&&M){if(n=B+"["+e+"]",r=JSON.parse(C.getItem(n+F)),r&&r.version===P&&r.url===t&&(0===r.expires||r.expires>(new Date).getTime()))return C.getItem(n+G);T.clear(e)}},set:function(e,t,n){var r,a;if(C&&M){r=B+"["+e+"]";try{if(a=le?C.remainingSpace:null,C.setItem(r+G,t),C.setItem(r+F,JSON.stringify({version:P,expires:R>0?(new Date).getTime()+R:0,url:n})),null!==a&&C.remainingSpace===a)throw"QuotaExceedError"}catch(u){l("unable to cache module "+e)}}},clear:function(e){var t,n,r,a;if(C)switch(typeof e){case z:t=B+"["+e+"]",C.removeItem(t+F),C.removeItem(t+G);break;case K:if(e)for(n in C)r=n.match(j),r&&(a=JSON.parse(C.getItem(B+"["+r[1]+"]"+F)),a&&a.expires>0&&a.expires<=(new Date).getTime()&&T.clear(r[1]));break;case Q:for(n in C)0===n.indexOf(B)&&C.removeItem(n)}}},I={resolve:function(e,t){var n=N.createElement("script");n.type="application/javascript",n.defer=n.async=!0,n.text=t,n.setAttribute("demand-path",e),X.appendChild(n)},modify:function(e,t){for(var n,r;n=re.exec(t);)r=c(S.url(e+"/../"+n[1])),t=t.replace(n[0],"//# sourcemap="+r+".map");return t}},k={resolve:function(e,t){var r=N.createElement("style"),a=r.styleSheet;r.type="text/css",r.media="only x",a&&(a.cssText=t)||(r.innerHTML=t),r.setAttribute("demand-path",e),X.appendChild(r),U(function(){n(function(){return r})})},modify:function(e,t){for(var n,r=S.url(e+"/..");n=ae.exec(t);)t=t.replace(n[0],"url("+S.url(r+n[1])+")");return t}},m.prototype={constructor:m,state:V,value:null,listener:null,then:null},m.defer=function(){var e={};return e.pledge=new m(function(t,n){e.resolve=t,e.reject=n}),e},m.all=function(e){var t=m.defer(),n=t.pledge,r=[],a=[],u=e.length,l=0;return e.forEach(function(e,n){e.then(function(){r[n]=J.call(arguments),l++,l===u&&t.resolve.apply(null,L.apply([],r))},function(){a.push(J.call(arguments)),a.length+l===u&&t.reject.apply(null,L.apply([],a))})}),n},m.race=function(e){var t=m.defer();return e.forEach(function(e){e.then(t.resolve,t.reject)}),t.pledge},g.prototype={message:null,module:null,stack:null,toString:function(){var e=this,t=B+" "+e.message+" "+e.module;return e.stack&&(t=g.traverse(e.stack,t,1)),t}},g.traverse=function(e,t,n){var r=new Array(n+1).join(" ");return e.forEach(function(e){t+="\n"+r+"> "+e.message+" "+e.module,e.stack&&(t=g.traverse(e.stack,t,n+1))}),t},v.prototype={weight:0,url:null,regexPattern:null,regexUrl:null,matches:function(e){return this.regexPattern.test(e)},remove:function(e){return e.replace(this.regexUrl,"")},process:function(e){var t=this;return e.replace(t.regexPattern,t.url)}},y.prototype={current:null,queue:null,length:0,add:function(e){var t=this,n=t.queue;n.push(e),t.length++,1===n.length&&t.next()},next:function(){var e,t,n,r=this,a=r.current,u=r.queue;a&&(r.current=null,u.shift(),r.length--),u.length&&(a=r.current=r.queue[0],e=a.defered,t=a.path,n=he[a.handler],!a.cached&&n.modify&&(a.source=n.modify(a.url,a.source)),n.resolve(t,a.source),fe[t]&&a.probe(),a.timeout=U(function(){e.reject(new g("timeout resolving module",t))},D))}},w.prototype={handler:null,path:null,url:null,defered:null,pledge:null,cached:!1,source:null,timeout:null,probe:function(){var e,t=this,r=t.path,a=t.pledge.state===V;a&&((e=fe[r]())?n(function(){return e}):U(t.probe,100))},store:function(){var e=this;T.set(e.path,e.source,e.url)},retrieve:function(){var e=this,t=T.get(e.path,e.url),n=e.cached=!!t;n&&(e.source=t)}},x.prototype={handler:null,path:null,pledge:null},b=o("^"+i(S.url("/"))),j=o("^"+i(B+"[(.+?)]"+F+"$")),E=new y,T.clear(!0),a("application/javascript",".js",I),a("text/css",".css",k),r(oe)&&ce&&r(ce),t.configure=r,t.addHandler=a,t.clear=T.clear,e.demand=t,e.provide=n,u("/demand",t),u("/provide",n),u("/pledge",m),u("/validator/isTypeOf",f),u("/validator/isInstanceOf",p),u("/validator/isObject",h),u("/validator/isPositiveInteger",d),ie&&t(ie)}(this);
//# sourceMappingURL=demand.js.map