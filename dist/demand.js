/*! Qoopido.demand 3.0.5 | https://github.com/dlueth/qoopido.demand | (c) 2016 Dirk Lueth */
!function(e,t,n,r,o,i,c,a,s,u){"use strict";function l(e){var t,n,r,o=ge[e];if(o)for(t=D.call(arguments,1),n=0;r=o[n];n++)r.apply(oe,t)}function f(e){b(console,"undefined")||console.error(e.toString())}function p(e,t){M(e,function(){return t})}function h(e){return e.replace(le,"\\$&")}function d(e,t){return new RegExp(e,t)}function m(){return+new Date}function g(e,t){return e=e.replace(ue,""),ce.test(e)||ae.test(e)||(e="/"+P((t&&P(t+"/../")||"/")+e).replace(A,"")),e}function v(e,t){var n,r,o;if(b(e,te)){if(n=g(e,t),t&&(e===L||e===N||e===_||e===B)){switch(e){case L:n=z+n,r=function(){var e,n=I.bind(t);for(e in I)n[e]=I[e];return n};break;case N:n=z+n,r=function(){return M.bind(t)};break;case _:n=K+t,r=function(){return pe.modules[t]||(pe.modules[t]={})};break;case B:n=V+t,r=function(){return t}}!de[n]&&M(n,r)}return(de[n]||(de[n]=new E(n,y(e,t)))).pledge}return j(e,T)?e:(o=T.defer(),o.resolve(e),o.pledge)}function y(e,t){var n,r,o=e.match(ue),i=pe.pattern;if(e=g(e,t),!ae.test(e))for(n in i)i[n].matches(e)&&(!r||r.weight<i[n].weight)&&(r=i[n]);return{mock:!(!o||!o[1]),cache:o&&o[2]?"+"===o[2]:oe,handler:o&&o[3]||pe.handler,version:o&&o[4]||pe.version,lifetime:o&&o[5]&&1e3*o[5]||pe.lifetime,url:r?P(r.process(e)):e}}function w(e){var t=e.handler;l("preProcess",e),e.deferred.pledge.state===Y&&(t.onPreProcess&&t.onPreProcess.call(e),t.process&&H.add(e))}function k(e){return"[object Array]"===X.call(e)}function R(e){return e&&b(e,"object")}function b(e,t){return typeof e===t}function j(e,t){return e instanceof t}function x(e){return b(e,"number")&&isFinite(e)&&Math.floor(e)===e&&e>=0}function P(e){return he.href=e,he.href}function q(e){for(var t,n,r,o=[],i=0;t=e[i];i++)r=t.match(ue),t=t.replace(ue,""),e[i]=(r?"mock:"+r.slice(1).join(""):"mock:")+"!"+t,n=(me[t]||(me[t]=T.defer())).pledge,o.push(n);return I.apply(oe,e),T.all(o)}function C(e,t){var n=this;n.weight=e.length,n.url=P(t).replace(se,"$1"),n.matchPattern=d("^"+h(e)),n.matchUrl=d("^"+h(t))}function E(e,t){var n,r,c=this,a=T.defer(),s=a.pledge,f=t.handler;return c.deferred=a,c.path=e,c.url=t.url,c.cache=t.cache,c.version=t.version,c.lifetime=t.lifetime,I(J+f).then(function(e){c.handler=e,c.mock=t.mock?me[c.path]:oe,e.onPreRequest&&e.onPreRequest.call(c),c.mock?c.mock.dependencies?c.mock.dependencies.then(function(){c.mock.resolve(c)},c.mock.reject):c.mock.resolve(c):c.cache!==!1&&$.get(c)?o(function(){w(c)}):(l("preRequest",c),s.state===Y&&(n=A.test(c.url)?new u:new ie,n.onprogress=function(){},n.ontimeout=n.onerror=n.onabort=function(){a.reject(new O("timeout requesting",c.path))},n.onload=function(){var t=n.getResponseHeader&&n.getResponseHeader("content-type");r=i(r),"status"in n&&200!==n.status||t&&e.matchType&&!e.matchType.test(t)?a.reject(new O("error requesting",c.path)):(c.source=n.responseText,l("postRequest",c),s.state===Y&&(e.onPostRequest&&e.onPostRequest.call(c),w(c),c.cache!==!1&&s.then(function(){$.set(c)})))},n.open("GET",c.url,!0),n.send(),r=o(function(){n.readyState<4&&n.abort()},pe.timeout)))},a.reject),a}function T(e){function t(){r(Z,arguments)}function n(){r(ee,arguments)}function r(e,t){var n,r;if(o.state===Y){for(o.state=e,o.value=t;n=i[e].shift();)r=n.handler.apply(oe,t),r&&"function"==typeof r.then?r.then(n.deferred.resolve,n.deferred.reject):n.deferred.resolve(r);i=oe}}var o=this,i={resolved:[],rejected:[]};o.then=function(e,t){var n=T.defer();if(o.state===Y)e&&i[Z].push({handler:e,deferred:n}),t&&i[ee].push({handler:t,deferred:n});else switch(o.state){case Z:n.resolve(e&&e.apply(oe,o.value));break;case ee:n.reject(t&&t.apply(oe,o.value))}return n.pledge},e(t,n)}function O(e,t,n){this.message=e,t&&(this.module=t),n&&(this.stack=D.call(n))}function S(){this.items=0,this.stack=[]}function I(){var e,t=D.call(arguments),n=this!==window?this:oe,r=0;for(l("preResolve",t,n);e=t[r];r++)t[r]=v(e,n);return l("postResolve",t,n),T.all(t)}function M(){var e,t,n,r=arguments,o=b(r[0],te)?r[0]:oe,i=k(r[o?1:0])?r[o?1:0]:oe,c=i?r[o?2:1]:r[o?1:0];if(!o&&H.current&&(o=H.current.path,H.current=oe,H.items>0&&H.process()),!o)throw"unspecified anonymous provide";o=g(o,this),e=de[o]||(de[o]=T.defer()),t=e.pledge,n=b(c,re),t.state===Y&&(i?I.apply(o,i).then(function(){e.resolve(n?c.apply(oe,arguments):c)},function(){f(new O("error providing",o,arguments))}):e.resolve(n?c():c))}var A,H,$,D=a.slice,U=a.concat,X=s.toString,L="demand",N="provide",_="settings",B="path",F="/"+L+"/",G=F+"storage/",J=F+"handler/",Q=F+"plugin/",z=F+"local",K=F+"settings",V=F+"paths",W=F+"validator/",Y="pending",Z="resolved",ee="rejected",te="string",ne="boolean",re="function",oe=null,ie="XDomainRequest"in e&&e.XDomainRequest||u,ce=/^\//,ae=/^(http(s?):)?\/\//i,se=/(.+)\/$/,ue=/^(mock:)?([+-])?((?:[-\w]+\/?)+)?(?:@(\d+\.\d+.\d+))?(?:#(\d+))?!/,le=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,fe=/^cache(Miss|Hit|Clear|Exceed)|(pre|post)(Configure.*|Resolve|Request|Process|Cache)$/,pe={cache:{},timeout:8e3,pattern:{},modules:{},handler:"module"},he=t.createElement("a"),de={},me={},ge={};C.prototype={matches:function(e){return this.matchPattern.test(e)},remove:function(e){return e.replace(this.matchUrl,"")},process:function(e){return e.replace(this.matchPattern,this.url)}},T.prototype={state:Y},T.defer=function(){var e={};return e.pledge=new T(function(t,n){e.resolve=t,e.reject=n}),e},T.all=function(e){function t(e,t){t.then(function(){i[e]=D.call(arguments),s++,n()},function(){c.push(D.call(arguments)),n()})}function n(){s===a?o.resolve.apply(oe,U.apply([],i)):c.length+s===a&&o.reject.apply(oe,U.apply([],c))}for(var r,o=T.defer(),i=[],c=[],a=e.length,s=0,u=0;r=e[u];u++)t(u,r);return o.pledge},T.race=function(e){for(var t,n=T.defer(),r=0;t=e[r];r++)t.then(n.resolve,n.reject);return n.pledge},O.prototype={toString:function(){var e=this,t=L+": "+e.message+" "+(e.module?'"'+e.module+'"':"");return e.stack&&(t=O.traverse(e.stack,t,1)),t}},O.traverse=function(e,t,n){for(var r,o=new Array(n+1).join(" "),i=0;r=e[i];i++)t+="\n"+o+"> "+r.message+" "+(r.module?'"'+r.module+'"':""),r.stack&&(t=O.traverse(r.stack,t,n+1));return t},S.prototype={add:function(){H.stack=H.stack.concat(D.call(arguments)),H.items+=arguments.length,!H.current&&H.process()},process:function(){var e;H.items&&(H.items--,e=H.current=H.stack.shift(),e.handler.process.call(e),l("postProcess",e))}},I.configure=function(e){var t,n,r,o=e.cache,i=e.version,c=e.timeout,a=e.lifetime,s=e.base,u=e.pattern,f=e.modules,p=pe.modules;if(b(o,ne))pe.cache[""]={weight:0,state:o};else if(R(o))for(t in o)pe.cache[t]={weight:t.length,state:o[t]};if(b(i,te)&&(pe.version=i),x(c)&&(pe.timeout=1e3*Math.min(Math.max(c,2),12)),x(a)&&a>0&&(pe.lifetime=1e3*a),b(s,te)&&""!==s&&(pe.pattern.base=new C("",s)),R(u))for(t in u)"base"!==t&&(pe.pattern[t]=new C(t,u[t]));if(R(f))for(t in f)if(t!==G){p[t]=p[t]||{},n=f[t],l("preConfigure:"+t,p[t]);for(r in n)p[t][r]=n[r];l("postConfigure:"+t,p[t])}},I.remove=function(e){de[e]&&(!!de[e].cache&&$.clean.path(e),delete de[e],delete me[e])},I.on=function(e,t){var n;if(b(e,te)&&b(t,re))for(e=e.split(" ");n=e.shift();)fe.test(n)&&(ge[n]||(ge[n]=[])).push(t);return I},I.list=function(e){var t,n,r;if(e){t=[];for(n in de)r=de[n].pledge,r.state!==e&&r.cache!==e||t.push(n)}else t=Object.keys(de);return t},function(){function t(){function t(e){var t,n,r;if(e.cache!==oe)return e.cache;for(t in pe.cache)n=pe.cache[t],0===e.path.indexOf(t)&&(!r||n.weight>r.weight)&&(r=n);return r?r.state:!1}function r(){this.clear.expired()}var o="["+L+"]",i="[state]",c="[value]",a=d("^"+h(o)+"\\[(.+?)\\]"+h(i)+"$"),s=function(){try{return"localStorage"in e&&e.localStorage}catch(t){return!1}}(),u=s&&"remainingSpace"in s;return r.prototype={get:function(e){var r,a,u,f=e.path;if(s&&t(e)){if(r=o+"["+f+"]",a=n.parse(s.getItem(r+i)),u=e.deferred.pledge,a&&a.version===e.version&&a.url===e.url&&(!a.expires&&!e.lifetime||a.expires>m()))return u.cache="hit",e.source=s.getItem(r+c),l("cacheHit",e),e.source;u.cache="miss",l("cacheMiss",e),this.clear.path(f)}},set:function(e){var r,a,f,p=e.path;if(s&&t(e)){l("preCache",e),r=e.lifetime,a=o+"["+p+"]",e.state={version:e.version,expires:r?m()+r:r,url:e.url};try{if(f=u?s.remainingSpace:oe,s.setItem(a+c,e.source),s.setItem(a+i,n.stringify(e.state)),f!==oe&&s.remainingSpace===f)throw"QUOTA_EXCEEDED_ERR";l("postCache",e)}catch(h){l("cacheExceed",e)}}},clear:{path:function(e){var t;s&&(t=o+"["+e+"]",s.removeItem(t+i),s.removeItem(t+c),l("cacheClear",e))},all:function(){var e,t;if(s)for(e in s)t=e.match(a),t&&this.path(t[1])},expired:function(){var e,t,r;if(s)for(e in s)t=e.match(a),t&&(r=n.parse(s.getItem(o+"["+t[1]+"]"+i)),r&&r.expires>0&&r.expires<=m()&&this.path(t[1]))}}},I.clear=($=new r).clear,$}M(G,t)}(),function(){function e(){var e=t.getElementsByTagName("head")[0],n=/\/\/#\s+sourceMappingURL\s*=\s*(?!(?:http[s]?:)?\/\/)(.+?)\.map/g;return{matchType:/^(application|text)\/(x-)?javascript/,onPreRequest:function(){var e=this.url;this.url=".js"!==e.slice(-3)?e+".js":e},onPostRequest:function(){var e,t,r=this,o=r.source;if(o){for(;e=n.exec(o);)ce.test(e[1])?(he.href=r.url,t=he.protocol+"//"+he.host+e[1]):t=P(r.url+"/../"+e[1]),o=o.replace(e[0],"//# sourceMappingURL="+t+".map");r.source=o}},process:function(){var n,r=this.source;r&&(n=t.createElement("script"),n.async=!0,n.text=r,n.setAttribute("demand-path",this.path),e.appendChild(n))}}}M(J+"module",e)}(),function(){function e(e,n){function r(t){e=R(t)?t:{}}return I.on("postConfigure:"+t,r),r(e),{matchType:n.matchType,onPostRequest:n.onPostRequest,onPreProcess:function(){var t=this,r=t.deferred,o=e[t.path];q(o).then(function(){H.add.apply(null,arguments),n.process.call(t),I.apply(null,o).then(r.resolve,function(){r.reject(new O("error resolving",t.path,arguments))})},function(){r.reject(new O("error mocking",null,arguments))})}}}var t=J+"bundle";M(t,["settings","/demand/handler/module"],e)}(),function(){function e(e){function r(e){if(R(e)){u.length=0;for(s in e)u.push({prefix:s,weight:s.length,fn:e[s]})}}function o(e){for(var t,n,r=0;t=u[r];r++)0===e.indexOf(t.prefix)&&(!n||t.weight>n.weight)&&(n=t);return n}function i(e){for(var t=0,n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(0),t&=t;return t}function c(e){var t,n,r=e.matches,o={pattern:{},modules:{"/demand/handler/bundle":{}}},i=0;for(o.pattern[e.id]=e.fn(r),o.modules["/demand/handler/bundle"][e.id]=t=[];n=r[i];i++)t.push(n.id);return o}function a(e){return de[e]&&de[e].pledge||me[e]&&me[e].pledge}var s,u=[];return I.on("postConfigure:"+t,r),r(e),I.on("preResolve",function(e,r){for(var s,u,l,f,p,h,d,m,v,w={},k=0;s=e[k];k++)b(s,"string")&&(u=g(s,r),!a(u)&&(l=y(s,r))&&"module"===l.handler&&(f=o(u))&&(w[f.prefix]||(w[f.prefix]={fn:f.fn,matches:[],mocks:[]})).matches.push({id:u,path:s,index:k}));if(p=Object.keys(w),p.length)for(h in w)if(d=w[h],m=d.matches,v=d.mocks,m.length>1){for(d.id=t+"/"+i(n.stringify(d.matches)),k=0;s=m[k];k++)e[s.index]="mock:!"+s.id,v.push(s.id);q(v),I.configure(c(d)),I("bundle!"+d.id)}}),!0}var t=Q+"genie";M(t,["settings"],e)}(),A=d("^"+h(P("/"))),I.configure({cache:!0,base:"/",pattern:{"/demand":P((c&&c.url||location.href)+"/../").slice(0,-1)}}),c&&c.settings&&I.configure(c.settings),p(W+"isArray",k),p(W+"isObject",R),p(W+"isTypeOf",b),p(W+"isInstanceOf",j),p(W+"isPositiveInteger",x),p(F+"pledge",T),p(F+"reason",O),H=new S,e.demand=I,e.provide=M,c&&c.main&&I(c.main)}(this,document,JSON,XMLHttpRequest,setTimeout,clearTimeout,"demand"in this&&demand,Array.prototype,Object.prototype,XMLHttpRequest);
//# sourceMappingURL=demand.js.map
