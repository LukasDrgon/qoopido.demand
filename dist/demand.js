/*! Qoopido.demand 1.0.9 | https://github.com/dlueth/qoopido.demand | (c) 2015 Dirk Lueth */
!function(e,t,n,r,a,o,u,i){"use strict";function c(){var e=this,t=q.defer(),n=b(e,S)||b(e,I)?e:ce,r=H.call(arguments);return o(function(){r.forEach(p,n),q.all(r).then(t.resolve,t.reject)}),t.pledge}function s(){var e,t,n=this,r=b(n,S)||b(n,I)?n:ce,a=x(arguments[0],re)?arguments[0]:ce,i=a?arguments[1]:arguments[0];if(!a&&O.current&&(e=O.current,a=e.type+"!"+e.path),a)return o(function(){var n,o,c,s=A.path(a,r),l=we[s.type]||(we[s.type]={});e||!l[s.path]?(n=new S(s.path,i,t),o=we[n.type][n.path]=n.pledge,e&&(e.timeout=u(e.timeout),c=e.defered,o.then(c.resolve,function(){c.reject(new R("unable to resolve module",a,arguments))}),!e.cached&&e.store(),O.length>0&&O.next())):m("duplicate found for module "+s.path)}),{when:function(){t=arguments}};throw new R("unspecified anonymous provide")}function l(e){var t,n=e.cache,r=e.storage,a=e.debug,o=e.version,u=e.timeout,i=e.lifetime,c=e.base,s=e.pattern,l=e.probes;if(C=x(n,ae)?n:C,F=x(r,re)?r:F,L=x(a,ae)?a:L,B=x(o,re)?o:B,E(u)&&(N=1e3*Math.min(Math.max(u,2),10),_=Math.min(Math.max(N/5,1e3),5e3)),E(i)&&(G=1e3*i),x(c,re)&&($=be.base=new P("",A.url(c))),j(s))for(t in s)"base"!==t&&(be[t]=new P(t,s[t]));if(j(l))for(t in l)xe[t]=l[t];return!0}function p(e,t,n){var r=this,a=A.path(e,r),o=a.type,u=a.path,i=we[o]||(we[o]={});n[t]=i[u]||(i[u]=new I(e,r).pledge)}function h(e,t){s(e,function(){return t})}function f(){return+new Date}function d(e){z.href=e;var t=z.search,n="demand[timestamp]="+f();return z.search+=t&&"?"!==t?"&"+n:"?"+n,z.href}function m(e){var t=b(e,R)?"error":"warn";x(console,ne)||!L&&"warn"===t||console[t](e.toString())}function g(e,t){return new RegExp(e,t)}function v(e){return e.replace(fe,"\\$&")}function y(e){return e.replace(me,"")}function w(e){return pe.test(e)}function b(e,t){return e instanceof t}function x(e,t){return typeof e===t}function j(e){return e&&x(e,"object")}function E(e){return x(e,"number")&&isFinite(e)&&Math.floor(e)===e&&e>=0}function q(e){function t(){r(ue,arguments)}function n(){r(ie,arguments)}function r(e,t){a.state===oe&&(a.state=e,a.value=t,o[e].forEach(function(e){e.apply(ce,t)}))}var a=this,o={resolved:[],rejected:[]};a.then=function(e,t){if(a.state===oe)e&&o[ue].push(e),t&&o[ie].push(t);else switch(a.state){case ue:e.apply(ce,a.value);break;case ie:t.apply(ce,a.value)}},e(t,n)}function R(e,t,n){var r=this;r.message=e,t&&(r.module=t),n&&(r.stack=H.call(n))}function P(e,t){var n=this;n.weight=e.length,n.url=A.url(t),n.regexPattern=g("^"+v(e)),n.regexUrl=g("^"+v(t))}function k(){var e=this;e.current=ce,e.queue=[]}function I(e,t){var n,r=this,a=q.defer();A.path.call(r,e,t),r.defered=a,r.pledge=a.pledge,t||r.pledge.then(ce,m),c(Z+r.type).then(function(e){e.onPreRequest&&e.onPreRequest.call(r),r.retrieve(),r.handler=e,r.probe=xe[r.path]||ce,r.cached?O.add(r):(n=M.test(r.url)?new se:new le,n.onprogress=function(){},n.ontimeout=n.onerror=n.onabort=function(){a.reject(new R("unable to load module",r.path))},n.onload=function(){r.timeout=u(r.timeout),"status"in n&&200!==n.status?a.reject(new R("unable to load module",r.path)):(r.source=n.responseText,O.add(r))},n.open("GET",d(r.url),!0),n.send(),r.timeout=o(function(){n.readyState<4&&n.abort()},N))},a.reject)}function S(e,t,n){var r=this,a=q.defer();A.path.call(r,e),(r.pledge=a.pledge).then(ce,function(){m(new R("unable to resolve module",r.path,arguments))}),n&&n.length>0?c.apply(r,n).then(function(){a.resolve(t.apply(ce,arguments))},function(){a.reject(new R("unable to resolve dependencies for",r.path,arguments))}):a.resolve(t())}var M,T,O,A,D,U,X,$,C,F,L,N,_,B,G,H=Array.prototype.slice,J=Array.prototype.concat,Q=t.getElementsByTagName("head")[0],z=t.createElement("a"),K="demand",V="["+K+"]",W="[state]",Y="[value]",Z="/"+K+"/handler/",ee="/"+K+"/storage/",te="/validator/",ne="undefined",re="string",ae="boolean",oe="pending",ue="resolved",ie="rejected",ce=null,se=a,le="XDomainRequest"in e&&e.XDomainRequest||se,pe=/^\//i,he=/^([-\w]+\/?)+!/,fe=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,de=/\/\/#\s+sourceMappingURL\s*=\s*(.+?)\.map/g,me=/^http(s?):/,ge=/^(http(s?):|)\/\//,ve=n&&"remainingSpace"in n,ye={cache:!0,storage:"localstorage",handler:"js",debug:!1,version:"1.0.0",lifetime:0,timeout:5,base:"/"},we={},be={},xe={};A={url:function(e){return z.href=e,z.href},path:function(e,t){var n,r,a=this,o=e.match(he)||ye.handler,u=b(a,I);if(x(o,re)||(e=e.replace(g("^"+v(o[0])),""),o=o[1]),!ge.test(e)){w(e)||(e="/"+A.url((t&&t.path&&A.url(t.path+"/../")||"/")+e).replace(M,""));for(n in be)be[n].matches(e)&&(!r||r.weight<be[n].weight)&&(r=be[n])}return u||b(a,S)?(a.type=o,a.path=e,u&&(a.url=r?y(A.url(r.process(e))):e),void 0):{type:o,path:e}}},X={get:function(e,t){var a,o;if(n){if(a=V+"["+e+"]",o=r.parse(n.getItem(a+W)),o&&o.version===B&&o.url===t&&(0===o.expires||o.expires>f()))return n.getItem(a+Y);X.clear.path(e)}},set:function(e,t,a){var o,u;if(n){o=V+"["+e+"]";try{if(u=ve?n.remainingSpace:ce,n.setItem(o+Y,t),n.setItem(o+W,r.stringify({version:B,expires:G>0?f()+G:0,url:a})),u!==ce&&n.remainingSpace===u)throw"QUOTA_EXCEEDED_ERR"}catch(i){m("unable to cache module "+e)}}},clear:{path:function(e){var t;n&&(t=V+"["+e+"]",n.removeItem(t+W),n.removeItem(t+Y))},all:function(){var e;if(n)for(e in n)0===e.indexOf(V)&&n.removeItem(e)},expired:function(){var e,t,a;if(n)for(e in n)t=e.match(T),t&&(a=r.parse(n.getItem(V+"["+t[1]+"]"+W)),a&&a.expires>0&&a.expires<=f()&&X.clear.path(t[1]))}}},U={onPreRequest:function(){var e=this,t=e.url;e.url=".js"!==t.slice(-3)?t+".js":t},onPostRequest:function(){var e,t,n=this,r=n.url,a=n.source;if(n.probe)for(;e=de.exec(a);)t=y(A.url(r+"/../"+e[1])),a=a.replace(e[0],"//# sourcemap="+t+".map");else a=a.replace(de,"");n.source=a},process:function(){var n,r,a=this,o=a.source;a.probe?(r=t.createElement("script"),r.async=!0,r.text=o,r.setAttribute("demand-path",a.path),Q.appendChild(r)):(n=c.bind(a),n.configure=c.configure,n.clear=c.clear,new Function("demand","provide",o).call(e,n,s.bind(a)))}},q.prototype={state:oe,value:ce,listener:ce,then:ce},q.defer=function(){var e={};return e.pledge=new q(function(t,n){e.resolve=t,e.reject=n}),e},q.all=function(e){var t=q.defer(),n=t.pledge,r=[],a=[],o=e.length,u=0;return e.forEach(function(e,n){e.then(function(){r[n]=H.call(arguments),u++,u===o&&t.resolve.apply(ce,J.apply([],r))},function(){a.push(H.call(arguments)),a.length+u===o&&t.reject.apply(ce,J.apply([],a))})}),n},q.race=function(e){var t=q.defer();return e.forEach(function(e){e.then(t.resolve,t.reject)}),t.pledge},R.prototype={message:ce,module:ce,stack:ce,toString:function(){var e=this,t=V+" "+e.message+" "+e.module;return e.stack&&(t=R.traverse(e.stack,t,1)),t}},R.traverse=function(e,t,n){var r=new Array(n+1).join(" ");return e.forEach(function(e){t+="\n"+r+"> "+e.message+" "+e.module,e.stack&&(t=R.traverse(e.stack,t,n+1))}),t},P.prototype={weight:0,url:ce,regexPattern:ce,regexUrl:ce,matches:function(e){return this.regexPattern.test(e)},remove:function(e){return e.replace(this.regexUrl,"")},process:function(e){var t=this;return e.replace(t.regexPattern,t.url)}},k.prototype={current:ce,queue:ce,length:0,add:function(e){var t=this,n=t.queue;n.push(e),t.length++,1===n.length&&t.next()},next:function(){var e,t,n,r=this,a=r.current,u=r.queue;a&&(r.current=ce,u.shift(),r.length--),u.length&&(a=r.current=r.queue[0],e=a.defered,t=a.path,n=a.handler,!a.cached&&n.onPostRequest&&n.onPostRequest.call(a),n.process.call(a),a.probe&&r.check(),a.timeout=o(function(){e.reject(new R("timeout resolving module",t))},_))},check:function(){var e,t=this,n=t.current;n.pledge.state===oe&&((e=n.probe())?s(function(){return e}):o(t.check,10))}},I.prototype={handler:ce,url:ce,defered:ce,cached:ce,source:ce,timeout:ce,probe:ce,store:function(){var e=this;C&&D.set(e.path,e.source,e.url)},retrieve:function(){var e=this,t=C&&D.get(e.path,e.url),n=e.cached=!!t;n&&(e.source=t)}},S.prototype={type:ce,path:ce,pledge:ce},M=g("^"+v(A.url("/"))),T=g("^"+v(V+"[(.+?)]"+W+"$")),O=new k,be["/"+K]=new P("/"+K,A.url((i&&i.url||location.href)+"/../").slice(0,-1)),l(ye)&&i&&i.settings&&l(i.settings),c.configure=l,e.demand=c,e.provide=s,h("/"+K,c),h("/provide",s),h("/pledge",q),h("/resolve/url",A.url),h(te+"isObject",j),h(te+"isTypeOf",x),h(te+"isInstanceOf",b),h(te+"isPositiveInteger",E),h(ee+ye.storage,X),h(Z+ye.handler,U),c(ee+F).then(function(e){D=e,c.clear=D.clear,D.clear.expired(),i&&i.main&&c(i.main)})}(this,document,function(){try{return"localStorage"in this&&localStorage}catch(e){return!1}}(),JSON,XMLHttpRequest,setTimeout,clearTimeout,"demand"in this&&demand);
//# sourceMappingURL=demand.js.map