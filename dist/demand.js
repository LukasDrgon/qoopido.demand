/*! Qoopido.demand 3.0.5 | https://github.com/dlueth/qoopido.demand | (c) 2016 Dirk Lueth */
!function(e,t,n,r,o,i,c,a,s,u,l){"use strict";function f(e){var t,n,r,o=we[e];if(o)for(t=X.call(arguments,1),n=0;r=o[n];n++)r.apply(ae,t)}function p(e){P(console,"undefined")||console.error(e.toString())}function h(e,t){H(e,function(){return t})}function d(e){for(var t,n,r,o=[],i=0;t=e[i];i++)r=t.match(pe),t=t.replace(pe,""),e[i]=(r?"mock:"+r.slice(1).join(""):"mock:")+"!"+t,n=(ye[t]||(ye[t]=S.defer())).pledge,o.push(n);return A.apply(ae,e),S.all(o)}function m(e){return e.replace(he,"\\$&")}function g(e,t){return new RegExp(e,t)}function v(){return+new Date}function y(e){return ge.href=e,ge.href}function w(e,t){return e=e.replace(pe,""),ue.test(e)||le.test(e)||(e="/"+y((t&&y(t+"/../")||"/")+e).replace($,"")),e}function k(e,t){var n,r,o;if(P(e,oe)){if(n=w(e,t),t&&(e===_||e===B||e===F||e===G)){switch(e){case _:n=V+n,r=function(){var e,n=A.bind(t);for(e in A)n[e]=A[e];return n};break;case B:n=V+n,r=function(){return H.bind(t)};break;case F:n=W+t,r=function(){return me.modules[t]};break;case G:n=Y+t,r=function(){return t}}!ve[n]&&H(n,r)}return(ve[n]||(ve[n]=new O(n,R(e,t)))).pledge}return q(e,S)?e:(o=S.defer(),o.resolve(e),o.pledge)}function R(e,t){var n,r,o=e.match(pe),i=me.pattern;if(e=w(e,t),!le.test(e))for(n in i)i[n].matches(e)&&(!r||r.weight<i[n].weight)&&(r=i[n]);return{mock:!(!o||!o[1]),cache:o&&o[2]?"+"===o[2]:ae,handler:o&&o[3]||me.handler,version:o&&o[4]||me.version,lifetime:o&&o[5]&&1e3*o[5]||me.lifetime,url:r?y(r.process(e)):e}}function b(e){var t=e.handler;f("preProcess",e),e.deferred.pledge.state===te&&(t.onPreProcess&&t.onPreProcess.call(e),t.process&&D.add(e))}function j(e){return"[object Array]"===N.call(e)}function x(e){return e&&P(e,"object")}function P(e,t){return typeof e===t}function q(e,t){return e instanceof t}function C(e){return P(e,"number")&&isFinite(e)&&Math.floor(e)===e&&e>=0}function E(){for(var e,t,n,r,o,i=arguments[0],c=1;(e=arguments[c])!==l;c++)for(t in e)n=i[t],o=e[t],o!==l&&(x(o)?(r=x(n),n=o.length!==l?r&&n.length!==l?n:[]:r&&n.length===l?n:{},i[t]=E(n,o)):i[t]=o);return i}function T(e,t){var n=this;n.weight=e.length,n.url=y(t).replace(fe,"$1"),n.matchPattern=g("^"+m(e)),n.matchUrl=g("^"+m(t))}function O(e,t){var n,r,c=this,a=S.defer(),s=a.pledge,l=t.handler;return c.deferred=a,c.path=e,c.url=t.url,c.cache=t.cache,c.version=t.version,c.lifetime=t.lifetime,A(z+l).then(function(e){c.handler=e,c.mock=t.mock?ye[c.path]:ae,e.onPreRequest&&e.onPreRequest.call(c),c.mock?c.mock.dependencies?c.mock.dependencies.then(function(){c.mock.resolve(c)},c.mock.reject):c.mock.resolve(c):c.cache!==!1&&U.get(c)?o(function(){b(c)}):(f("preRequest",c),s.state===te&&(n=$.test(c.url)?new u:new se,n.onprogress=function(){},n.ontimeout=n.onerror=n.onabort=function(){a.reject(new I("timeout requesting",c.path))},n.onload=function(){var t=n.getResponseHeader&&n.getResponseHeader("content-type");r=i(r),"status"in n&&200!==n.status||t&&e.matchType&&!e.matchType.test(t)?a.reject(new I("error requesting",c.path)):(c.source=n.responseText,f("postRequest",c),s.state===te&&(e.onPostRequest&&e.onPostRequest.call(c),b(c),c.cache!==!1&&s.then(function(){U.set(c)})))},n.open("GET",c.url,!0),n.send(),r=o(function(){n.readyState<4&&n.abort()},me.timeout)))},a.reject),a}function S(e){function t(){r(ne,arguments)}function n(){r(re,arguments)}function r(e,t){var n,r;if(o.state===te){for(o.state=e,o.value=t;n=i[e].shift();)r=n.handler.apply(ae,t),r&&"function"==typeof r.then?r.then(n.deferred.resolve,n.deferred.reject):n.deferred.resolve(r);i=ae}}var o=this,i={resolved:[],rejected:[]};o.then=function(e,t){var n=S.defer();if(o.state===te)e&&i[ne].push({handler:e,deferred:n}),t&&i[re].push({handler:t,deferred:n});else switch(o.state){case ne:n.resolve(e&&e.apply(ae,o.value));break;case re:n.reject(t&&t.apply(ae,o.value))}return n.pledge},e(t,n)}function I(e,t,n){this.message=e,t&&(this.module=t),n&&(this.stack=X.call(n))}function M(){this.items=0,this.stack=[]}function A(){var e,t=X.call(arguments),n=this!==window?this:ae,r=0;for(f("preResolve",t,n);e=t[r];r++)t[r]=k(e,n);return f("postResolve",t,n),S.all(t)}function H(){var e,t,n,r=arguments,o=P(r[0],oe)?r[0]:ae,i=j(r[o?1:0])?r[o?1:0]:ae,c=i?r[o?2:1]:r[o?1:0];if(!o&&D.current&&(o=D.current.path,D.current=ae,D.items>0&&D.process()),!o)throw"unspecified anonymous provide";o=w(o,this),e=ve[o]||(ve[o]=S.defer()),t=e.pledge,n=P(c,ce),t.state===te&&(i?A.apply(o,i).then(function(){e.resolve(n?c.apply(ae,arguments):c)},function(){p(new I("error providing",o,arguments))}):e.resolve(n?c():c))}var $,D,U,X=a.slice,L=a.concat,N=s.toString,_="demand",B="provide",F="settings",G="path",J="/"+_+"/",Q=J+"storage/",z=J+"handler/",K=J+"plugin/",V=J+"local",W=J+"settings",Y=J+"paths",Z=J+"function/",ee=J+"validator/",te="pending",ne="resolved",re="rejected",oe="string",ie="boolean",ce="function",ae=null,se="XDomainRequest"in e&&e.XDomainRequest||u,ue=/^\//,le=/^(http(s?):)?\/\//i,fe=/(.+)\/$/,pe=/^(mock:)?([+-])?((?:[-\w]+\/?)+)?(?:@(\d+\.\d+.\d+))?(?:#(\d+))?!/,he=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,de=/^cache(Miss|Hit|Clear|Exceed)|(pre|post)(Configure.*|Resolve|Request|Process|Cache)$/,me={cache:{},timeout:8e3,pattern:{},modules:{},handler:"module"},ge=t.createElement("a"),ve={},ye={},we={};T.prototype={matches:function(e){return this.matchPattern.test(e)},remove:function(e){return e.replace(this.matchUrl,"")},process:function(e){return e.replace(this.matchPattern,this.url)}},S.prototype={state:te},S.defer=function(){var e={};return e.pledge=new S(function(t,n){e.resolve=t,e.reject=n}),e},S.all=function(e){function t(e,t){t.then(function(){i[e]=X.call(arguments),s++,n()},function(){c.push(X.call(arguments)),n()})}function n(){s===a?o.resolve.apply(ae,L.apply([],i)):c.length+s===a&&o.reject.apply(ae,L.apply([],c))}for(var r,o=S.defer(),i=[],c=[],a=e.length,s=0,u=0;r=e[u];u++)t(u,r);return o.pledge},S.race=function(e){for(var t,n=S.defer(),r=0;t=e[r];r++)t.then(n.resolve,n.reject);return n.pledge},I.prototype={toString:function(){var e=this,t=_+": "+e.message+" "+(e.module?'"'+e.module+'"':"");return e.stack&&(t=I.traverse(e.stack,t,1)),t}},I.traverse=function(e,t,n){for(var r,o=new Array(n+1).join(" "),i=0;r=e[i];i++)t+="\n"+o+"> "+r.message+" "+(r.module?'"'+r.module+'"':""),r.stack&&(t=I.traverse(r.stack,t,n+1));return t},M.prototype={add:function(){D.stack=D.stack.concat(X.call(arguments)),D.items+=arguments.length,!D.current&&D.process()},process:function(){var e;D.items&&(D.items--,e=D.current=D.stack.shift(),e.handler.process.call(e),f("postProcess",e))}},A.configure=function(e){var t,n,r=e.cache,o=e.version,i=e.timeout,c=e.lifetime,a=e.base,s=e.pattern,u=e.modules,l=me.modules;if(P(r,ie))me.cache[""]={weight:0,state:r};else if(x(r))for(t in r)me.cache[t]={weight:t.length,state:r[t]};if(P(o,oe)&&(me.version=o),C(i)&&(me.timeout=1e3*Math.min(Math.max(i,2),12)),C(c)&&c>0&&(me.lifetime=1e3*c),P(a,oe)&&""!==a&&(me.pattern.base=new T("",a)),x(s))for(t in s)"base"!==t&&(me.pattern[t]=new T(t,s[t]));if(x(u))for(t in u)t!==Q&&(n=l[t]=l[t]||{},f("preConfigure:"+t,n),E(n,u[t]),f("postConfigure:"+t,n))},A.remove=function(e){ve[e]&&(!!ve[e].cache&&U.clean.path(e),delete ve[e],delete ye[e])},A.on=function(e,t){var n;if(P(e,oe)&&P(t,ce))for(e=e.split(" ");n=e.shift();)de.test(n)&&(we[n]||(we[n]=[])).push(t);return A},A.list=function(e){var t,n,r;if(e){t=[];for(n in ve)r=ve[n].pledge,r.state!==e&&r.cache!==e||t.push(n)}else t=Object.keys(ve);return t},function(){function t(){function t(e){var t,n,r;if(e.cache!==ae)return e.cache;for(t in me.cache)n=me.cache[t],0===e.path.indexOf(t)&&(!r||n.weight>r.weight)&&(r=n);return r?r.state:!1}function r(){this.clear.expired()}var o="["+_+"]",i="[state]",c="[value]",a=g("^"+m(o)+"\\[(.+?)\\]"+m(i)+"$"),s=function(){try{return"localStorage"in e&&e.localStorage}catch(t){return!1}}(),u=s&&"remainingSpace"in s;return r.prototype={get:function(e){var r,a,u,l=e.path;if(s&&t(e)){if(r=o+"["+l+"]",a=n.parse(s.getItem(r+i)),u=e.deferred.pledge,a&&a.version===e.version&&a.url===e.url&&(!a.expires&&!e.lifetime||a.expires>v()))return u.cache="hit",e.source=s.getItem(r+c),f("cacheHit",e),e.source;u.cache="miss",f("cacheMiss",e),this.clear.path(l)}},set:function(e){var r,a,l,p=e.path;if(s&&t(e)){f("preCache",e),r=e.lifetime,a=o+"["+p+"]",e.state={version:e.version,expires:r?v()+r:r,url:e.url};try{if(l=u?s.remainingSpace:ae,s.setItem(a+c,e.source),s.setItem(a+i,n.stringify(e.state)),l!==ae&&s.remainingSpace===l)throw"QUOTA_EXCEEDED_ERR";f("postCache",e)}catch(h){f("cacheExceed",e)}}},clear:{path:function(e){var t;s&&(t=o+"["+e+"]",s.removeItem(t+i),s.removeItem(t+c),f("cacheClear",e))},all:function(){var e,t;if(s)for(e in s)t=e.match(a),t&&this.path(t[1])},expired:function(){var e,t,r;if(s)for(e in s)t=e.match(a),t&&(r=n.parse(s.getItem(o+"["+t[1]+"]"+i)),r&&r.expires>0&&r.expires<=v()&&this.path(t[1]))}}},A.clear=(U=new r).clear,U}H(Q,t)}(),function(){function e(){var e=t.getElementsByTagName("head")[0],n=/\/\/#\s+sourceMappingURL\s*=\s*(?!(?:http[s]?:)?\/\/)(.+?)\.map/g;return{matchType:/^(application|text)\/(x-)?javascript/,onPreRequest:function(){var e=this.url;this.url=".js"!==e.slice(-3)?e+".js":e},onPostRequest:function(){var e,t,r=this,o=r.source;if(o){for(;e=n.exec(o);)ue.test(e[1])?(ge.href=r.url,t=ge.protocol+"//"+ge.host+e[1]):t=y(r.url+"/../"+e[1]),o=o.replace(e[0],"//# sourceMappingURL="+t+".map");r.source=o}},process:function(){var n,r=this.source;r&&(n=t.createElement("script"),n.async=!0,n.text=r,n.setAttribute("demand-path",this.path),e.appendChild(n))}}}H(z+"module",e)}(),function(){function e(e,n){function r(t){e=x(t)?t:{}}return A.on("postConfigure:"+t,r),r(e),{matchType:n.matchType,onPostRequest:n.onPostRequest,onPreProcess:function(){var t=this,r=t.deferred,o=e[t.path];d(o).then(function(){D.add.apply(null,arguments),n.process.call(t),A.apply(null,o).then(r.resolve,function(){r.reject(new I("error resolving",t.path,arguments))})},function(){r.reject(new I("error mocking",null,arguments))})}}}var t=z+"bundle";H(t,["settings","/demand/handler/module"],e)}(),function(){function e(e){function r(e){if(x(e)){u.length=0;for(s in e)u.push({prefix:s,weight:s.length,fn:e[s]})}}function o(e){for(var t,n,r=0;t=u[r];r++)0===e.indexOf(t.prefix)&&(!n||t.weight>n.weight)&&(n=t);return n}function i(e){for(var t=0,n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(0),t&=t;return t}function c(e){var t,n,r=e.matches,o={pattern:{},modules:{"/demand/handler/bundle":{}}},i=0;for(o.pattern[e.id]=e.fn(r),o.modules["/demand/handler/bundle"][e.id]=t=[];n=r[i];i++)t.push(n.id);return o}function a(e){return ve[e]&&ve[e].pledge||ye[e]&&ye[e].pledge}var s,u=[];return A.on("postConfigure:"+t,r),r(e),A.on("preResolve",function(e,r){for(var s,u,l,f,p,h,m,g,v,y={},k=0;s=e[k];k++)P(s,"string")&&(u=w(s,r),!a(u)&&(l=R(s,r))&&"module"===l.handler&&(f=o(u))&&(y[f.prefix]||(y[f.prefix]={fn:f.fn,matches:[],mocks:[]})).matches.push({id:u,path:s,index:k}));if(p=Object.keys(y),p.length)for(h in y)if(m=y[h],g=m.matches,v=m.mocks,g.length>1){for(m.id=t+"/"+i(n.stringify(m.matches)),k=0;s=g[k];k++)e[s.index]="mock:!"+s.id,v.push(s.id);d(v),A.configure(c(m)),A("bundle!"+m.id)}}),!0}var t=K+"genie";H(t,["settings"],e)}(),$=g("^"+m(y("/"))),A.configure({cache:!0,base:"/",pattern:{"/demand":y((c&&c.url||location.href)+"/../").slice(0,-1)}}),c&&c.settings&&A.configure(c.settings),h(ee+"isArray",j),h(ee+"isObject",x),h(ee+"isTypeOf",P),h(ee+"isInstanceOf",q),h(ee+"isPositiveInteger",C),h(Z+"merge",E),h(J+"pledge",S),h(J+"reason",I),D=new M,e.demand=A,e.provide=H,c&&c.main&&A(c.main)}(this,document,JSON,XMLHttpRequest,setTimeout,clearTimeout,"demand"in this&&demand,Array.prototype,Object.prototype,XMLHttpRequest);
//# sourceMappingURL=demand.js.map
